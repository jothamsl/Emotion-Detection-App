<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{ title or "Emotion Detection Web App" }}</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            body {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
            }
            .main-card {
                background: rgba(255, 255, 255, 0.95);
                border-radius: 20px;
            }
            .upload-zone {
                border: 3px dashed #007bff;
                border-radius: 15px;
                padding: 3rem 2rem;
                text-align: center;
                cursor: pointer;
            }
            .upload-zone:hover {
                border-color: #0056b3;
            }
            .result-section {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="container mt-5">
            <h1 class="text-white text-center mb-4">
                Emotion Detection Web App
            </h1>
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card main-card">
                        <div class="card-body p-5">
                            <!-- Mode Selection Tabs -->
                            <ul
                                class="nav nav-tabs"
                                id="modeTabs"
                                role="tablist"
                            >
                                <li class="nav-item" role="presentation">
                                    <button
                                        class="nav-link active"
                                        id="upload-tab"
                                        data-bs-toggle="tab"
                                        data-bs-target="#upload-pane"
                                        type="button"
                                        role="tab"
                                    >
                                        Upload Image
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button
                                        class="nav-link"
                                        id="camera-tab"
                                        data-bs-toggle="tab"
                                        data-bs-target="#camera-pane"
                                        type="button"
                                        role="tab"
                                    >
                                        Live Camera
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="modeTabContent">
                                <!-- Upload Image Tab -->
                                <div
                                    class="tab-pane fade show active"
                                    id="upload-pane"
                                    role="tabpanel"
                                >
                                    <form
                                        id="uploadForm"
                                        enctype="multipart/form-data"
                                        class="mt-3"
                                    >
                                        <div
                                            class="upload-zone"
                                            id="uploadZone"
                                        >
                                            <h4>
                                                Upload Image for Emotion
                                                Detection
                                            </h4>
                                            <p>
                                                Click to browse or drag and drop
                                            </p>
                                            <input
                                                type="file"
                                                id="fileInput"
                                                name="file"
                                                accept="image/*"
                                                style="display: none"
                                            />
                                            <button
                                                type="button"
                                                class="btn btn-primary"
                                                onclick="document.getElementById('fileInput').click()"
                                            >
                                                Choose File
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Live Camera Tab -->
                                <div
                                    class="tab-pane fade"
                                    id="camera-pane"
                                    role="tabpanel"
                                >
                                    <div class="text-center mt-3">
                                        <h4>Live Camera Emotion Detection</h4>
                                        <div id="cameraSection" class="mt-4">
                                            <video
                                                id="videoElement"
                                                width="480"
                                                height="360"
                                                autoplay
                                                muted
                                                style="
                                                    border-radius: 10px;
                                                    display: none;
                                                "
                                            ></video>
                                            <canvas
                                                id="captureCanvas"
                                                width="480"
                                                height="360"
                                                style="display: none"
                                            ></canvas>
                                            <div
                                                id="cameraButtons"
                                                class="mt-3"
                                            >
                                                <button
                                                    type="button"
                                                    class="btn btn-success me-2"
                                                    id="startCamera"
                                                >
                                                    Start Camera
                                                </button>
                                                <button
                                                    type="button"
                                                    class="btn btn-danger me-2"
                                                    id="stopCamera"
                                                    style="display: none"
                                                >
                                                    Stop Camera
                                                </button>
                                                <button
                                                    type="button"
                                                    class="btn btn-primary"
                                                    id="captureBtn"
                                                    style="display: none"
                                                >
                                                    Capture & Analyze
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div
                                id="loadingSpinner"
                                class="text-center mt-4 d-none"
                            >
                                <div class="spinner-border text-primary"></div>
                                <p>Analyzing emotion...</p>
                            </div>

                            <div id="resultSection" class="result-section mt-4">
                                <h5>Results:</h5>
                                <div id="emotionResult"></div>
                                <img
                                    id="previewImage"
                                    class="img-fluid mt-3"
                                    style="max-height: 300px"
                                />
                            </div>

                            <div
                                id="errorAlert"
                                class="alert alert-danger mt-4"
                                style="display: none"
                            >
                                <span id="errorMessage"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5>Total Predictions</h5>
                            <h2 class="text-primary">
                                {{ stats.total_predictions or 0 }}
                            </h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>Top Emotions</h5>
                            {% if stats.emotion_counts %}{% set items =
                            stats.emotion_counts.items() | list %}{% for
                            emotion, count in items[:3] %}
                            <div>{{ emotion }}: {{ count }}</div>
                            {% endfor %}{% else %}
                            <p>No data</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>Recent Activity</h5>
                            {% if stats.recent_predictions %}{% for pred in
                            stats.recent_predictions[:3] %}
                            <div>{{ pred[1] }} - {{ pred[4] }}</div>
                            {% endfor %}{% else %}
                            <p>No activity</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            const fileInput = document.getElementById("fileInput");
            const uploadZone = document.getElementById("uploadZone");
            const loadingSpinner = document.getElementById("loadingSpinner");
            const resultSection = document.getElementById("resultSection");
            const errorAlert = document.getElementById("errorAlert");

            // Camera elements
            const videoElement = document.getElementById("videoElement");
            const captureCanvas = document.getElementById("captureCanvas");
            const startCameraBtn = document.getElementById("startCamera");
            const stopCameraBtn = document.getElementById("stopCamera");
            const captureBtn = document.getElementById("captureBtn");

            let currentStream = null;

            // Upload functionality
            uploadZone.addEventListener("click", () => fileInput.click());
            fileInput.addEventListener("change", handleFileSelect);

            // Camera functionality
            startCameraBtn.addEventListener("click", startCamera);
            stopCameraBtn.addEventListener("click", stopCamera);
            captureBtn.addEventListener("click", captureAndAnalyze);

            function handleFileSelect() {
                const file = fileInput.files[0];
                if (file) uploadFile(file);
            }

            function uploadFile(file) {
                resultSection.style.display = "none";
                errorAlert.style.display = "none";
                loadingSpinner.classList.remove("d-none");

                const reader = new FileReader();
                reader.onload = (e) =>
                    (document.getElementById("previewImage").src =
                        e.target.result);
                reader.readAsDataURL(file);

                const formData = new FormData();
                formData.append("file", file);

                fetch("/predict", { method: "POST", body: formData })
                    .then((response) => response.json())
                    .then(handlePredictionResponse)
                    .catch(handleError);
            }

            async function startCamera() {
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: 480,
                            height: 360,
                            facingMode: "user",
                        },
                    });

                    videoElement.srcObject = currentStream;
                    videoElement.style.display = "block";

                    startCameraBtn.style.display = "none";
                    stopCameraBtn.style.display = "inline-block";
                    captureBtn.style.display = "inline-block";

                    hideResults();
                } catch (error) {
                    showError(
                        "Camera access denied or not available: " +
                            error.message,
                    );
                }
            }

            function stopCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach((track) => track.stop());
                    currentStream = null;
                }

                videoElement.style.display = "none";
                videoElement.srcObject = null;

                startCameraBtn.style.display = "inline-block";
                stopCameraBtn.style.display = "none";
                captureBtn.style.display = "none";
            }

            function captureAndAnalyze() {
                const canvas = captureCanvas;
                const context = canvas.getContext("2d");

                // Draw video frame to canvas
                context.drawImage(videoElement, 0, 0, 480, 360);

                // Convert canvas to blob
                canvas.toBlob(
                    (blob) => {
                        if (blob) {
                            resultSection.style.display = "none";
                            errorAlert.style.display = "none";
                            loadingSpinner.classList.remove("d-none");

                            // Show captured image
                            const imageUrl = URL.createObjectURL(blob);
                            document.getElementById("previewImage").src =
                                imageUrl;

                            // Send to server
                            const formData = new FormData();
                            formData.append("file", blob, "camera_capture.jpg");

                            fetch("/predict", {
                                method: "POST",
                                body: formData,
                            })
                                .then((response) => response.json())
                                .then(handlePredictionResponse)
                                .catch(handleError);
                        }
                    },
                    "image/jpeg",
                    0.8,
                );
            }

            function handlePredictionResponse(data) {
                loadingSpinner.classList.add("d-none");
                if (data.error) {
                    showError(data.error);
                } else {
                    document.getElementById("emotionResult").innerHTML =
                        "<h4>Emotion: " +
                        data.predicted_emotion.toUpperCase() +
                        "</h4><p>Confidence: " +
                        (data.confidence * 100).toFixed(1) +
                        "%</p>";
                    resultSection.style.display = "block";
                }
            }

            function handleError(error) {
                loadingSpinner.classList.add("d-none");
                showError("Error: " + error.message);
            }

            function showError(message) {
                document.getElementById("errorMessage").textContent = message;
                errorAlert.style.display = "block";
            }

            function hideResults() {
                resultSection.style.display = "none";
                errorAlert.style.display = "none";
            }

            // Clean up camera when page unloads
            window.addEventListener("beforeunload", () => {
                if (currentStream) {
                    currentStream.getTracks().forEach((track) => track.stop());
                }
            });
        </script>
    </body>
</html>
