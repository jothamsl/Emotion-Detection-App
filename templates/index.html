<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{{ title or "Emotion Detection Web App" }}</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            body {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
            }
            .main-card {
                background: rgba(255, 255, 255, 0.95);
                border-radius: 20px;
            }
            .upload-zone {
                border: 3px dashed #007bff;
                border-radius: 15px;
                padding: 3rem 2rem;
                text-align: center;
                cursor: pointer;
            }
            .upload-zone:hover {
                border-color: #0056b3;
            }
            .result-section {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="container mt-5">
            <h1 class="text-white text-center mb-4">
                Emotion Detection Web App
            </h1>
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card main-card">
                        <div class="card-body p-5">
                            <form id="uploadForm" enctype="multipart/form-data">
                                <div class="upload-zone" id="uploadZone">
                                    <h4>Upload Image for Emotion Detection</h4>
                                    <p>Click to browse or drag and drop</p>
                                    <input
                                        type="file"
                                        id="fileInput"
                                        name="file"
                                        accept="image/*"
                                        style="display: none"
                                    />
                                    <button
                                        type="button"
                                        class="btn btn-primary"
                                        onclick="document.getElementById('fileInput').click()"
                                    >
                                        Choose File
                                    </button>
                                </div>
                            </form>

                            <div
                                id="loadingSpinner"
                                class="text-center mt-4 d-none"
                            >
                                <div class="spinner-border text-primary"></div>
                                <p>Analyzing emotion...</p>
                            </div>

                            <div id="resultSection" class="result-section mt-4">
                                <h5>Results:</h5>
                                <div id="emotionResult"></div>
                                <img
                                    id="previewImage"
                                    class="img-fluid mt-3"
                                    style="max-height: 300px"
                                />
                            </div>

                            <div
                                id="errorAlert"
                                class="alert alert-danger mt-4"
                                style="display: none"
                            >
                                <span id="errorMessage"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5>Total Predictions</h5>
                            <h2 class="text-primary">
                                {{ stats.total_predictions or 0 }}
                            </h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>Top Emotions</h5>
                            {% if stats.emotion_counts %}{% set items =
                            stats.emotion_counts.items() | list %}{% for
                            emotion, count in items[:3] %}
                            <div>{{ emotion }}: {{ count }}</div>
                            {% endfor %}{% else %}
                            <p>No data</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h5>Recent Activity</h5>
                            {% if stats.recent_predictions %}{% for pred in
                            stats.recent_predictions[:3] %}
                            <div>{{ pred[1] }} - {{ pred[4] }}</div>
                            {% endfor %}{% else %}
                            <p>No activity</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const fileInput = document.getElementById("fileInput");
            const uploadZone = document.getElementById("uploadZone");
            const loadingSpinner = document.getElementById("loadingSpinner");
            const resultSection = document.getElementById("resultSection");
            const errorAlert = document.getElementById("errorAlert");

            uploadZone.addEventListener("click", () => fileInput.click());
            fileInput.addEventListener("change", handleFileSelect);

            function handleFileSelect() {
                const file = fileInput.files[0];
                if (file) uploadFile(file);
            }

            function uploadFile(file) {
                resultSection.style.display = "none";
                errorAlert.style.display = "none";
                loadingSpinner.classList.remove("d-none");

                const reader = new FileReader();
                reader.onload = (e) =>
                    (document.getElementById("previewImage").src =
                        e.target.result);
                reader.readAsDataURL(file);

                const formData = new FormData();
                formData.append("file", file);

                fetch("/predict", { method: "POST", body: formData })
                    .then((response) => response.json())
                    .then((data) => {
                        loadingSpinner.classList.add("d-none");
                        if (data.error) {
                            document.getElementById(
                                "errorMessage",
                            ).textContent = data.error;
                            errorAlert.style.display = "block";
                        } else {
                            document.getElementById("emotionResult").innerHTML =
                                "<h4>Emotion: " +
                                data.predicted_emotion.toUpperCase() +
                                "</h4><p>Confidence: " +
                                (data.confidence * 100).toFixed(1) +
                                "%</p>";
                            resultSection.style.display = "block";
                        }
                    })
                    .catch((error) => {
                        loadingSpinner.classList.add("d-none");
                        document.getElementById("errorMessage").textContent =
                            "Error: " + error.message;
                        errorAlert.style.display = "block";
                    });
            }
        </script>
    </body>
</html>
